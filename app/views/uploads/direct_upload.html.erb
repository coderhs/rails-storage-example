<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-8">Direct Upload to Local Storage</h1>

  <div class="mb-4">
    <%= link_to "â† Back to Regular Uploads", uploads_path, class: "text-blue-500 hover:underline" %>
  </div>

  <div id="flash">
    <% if notice %>
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <%= notice %>
      </div>
    <% end %>
  </div>

  <!-- Direct Upload Form -->
  <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-8">
    <h2 class="text-xl font-semibold mb-4">Direct Upload a File</h2>
    <p class="text-gray-600 mb-4">Files are uploaded directly to local storage using JavaScript.</p>

    <%= form_with model: Upload.new, url: create_direct_upload_path, method: :post, id: "direct-upload-form", class: "space-y-4", data: { turbo: false }, multipart: true do |form| %>
      <div>
        <%= form.label :name, "File Name", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.text_field :name, required: true, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
      </div>

      <div>
        <%= form.label :file, "Select File", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.file_field :file,
            direct_upload: true,
            required: true,
            class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
            data: { direct_upload: true } %>
      </div>

      <!-- Upload Progress -->
      <div id="upload-progress" class="hidden">
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
          <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="text-sm text-gray-600">Uploading...</p>
      </div>

      <!-- Upload Status -->
      <div id="upload-status" class="hidden"></div>

      <%= form.submit "Upload File", class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline", id: "upload-button" %>
    <% end %>
  </div>

  <!-- Uploads Table -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold mb-4">Uploaded Files</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow-md rounded">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left">ID</th>
            <th class="px-4 py-2 text-left">Name</th>
            <th class="px-4 py-2 text-left">File</th>
            <th class="px-4 py-2 text-left">Created At</th>
            <th class="px-4 py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="uploads">
          <% @uploads.each do |upload| %>
            <tr class="border-t" id="<%= dom_id(upload) %>">
              <td class="px-4 py-2"><%= upload.id %></td>
              <td class="px-4 py-2"><%= upload.name %></td>
              <td class="px-4 py-2">
                <% if upload.file.attached? %>
                  <%= link_to upload.file.filename, rails_blob_path(upload.file, disposition: "attachment"), class: "text-blue-500 hover:underline" %>
                <% end %>
              </td>
              <td class="px-4 py-2"><%= upload.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              <td class="px-4 py-2">
                <%= button_to "Delete", upload_path(upload), method: :delete, class: "bg-red-500 hover:bg-red-700 text-white text-sm py-1 px-2 rounded", data: { turbo_confirm: "Are you sure?" } %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Active Storage Attachments Table -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold mb-4">Active Storage Attachments</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow-md rounded">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left">ID</th>
            <th class="px-4 py-2 text-left">Name</th>
            <th class="px-4 py-2 text-left">Record Type</th>
            <th class="px-4 py-2 text-left">Record ID</th>
            <th class="px-4 py-2 text-left">Blob ID</th>
            <th class="px-4 py-2 text-left">Created At</th>
          </tr>
        </thead>
        <tbody id="attachments">
          <% @uploads.each do |upload| %>
            <% if upload.file.attached? %>
              <% attachment = upload.file.attachment %>
              <tr class="border-t" id="attachment_<%= attachment.id %>">
                <td class="px-4 py-2"><%= attachment.id %></td>
                <td class="px-4 py-2"><%= attachment.name %></td>
                <td class="px-4 py-2"><%= attachment.record_type %></td>
                <td class="px-4 py-2"><%= attachment.record_id %></td>
                <td class="px-4 py-2"><%= attachment.blob_id %></td>
                <td class="px-4 py-2"><%= attachment.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Active Storage Blobs Table -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold mb-4">Active Storage Blobs</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow-md rounded">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left">ID</th>
            <th class="px-4 py-2 text-left">Key</th>
            <th class="px-4 py-2 text-left">Filename</th>
            <th class="px-4 py-2 text-left">Content Type</th>
            <th class="px-4 py-2 text-left">Byte Size</th>
            <th class="px-4 py-2 text-left">Checksum</th>
            <th class="px-4 py-2 text-left">Created At</th>
          </tr>
        </thead>
        <tbody id="blobs">
          <% @uploads.each do |upload| %>
            <% if upload.file.attached? %>
              <% blob = upload.file.blob %>
              <tr class="border-t" id="blob_<%= blob.id %>">
                <td class="px-4 py-2"><%= blob.id %></td>
                <td class="px-4 py-2 text-xs font-mono"><%= truncate(blob.key, length: 20) %></td>
                <td class="px-4 py-2"><%= blob.filename %></td>
                <td class="px-4 py-2"><%= blob.content_type %></td>
                <td class="px-4 py-2"><%= number_to_human_size(blob.byte_size) %></td>
                <td class="px-4 py-2 text-xs font-mono"><%= truncate(blob.checksum, length: 15) %></td>
                <td class="px-4 py-2"><%= blob.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Wait for both DOM and Active Storage to be ready
function initializeDirectUpload() {
  console.log('Initializing direct upload handlers');

  const form = document.getElementById('direct-upload-form');
  const fileInput = form?.querySelector('input[type="file"]');
  const progressContainer = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const uploadStatus = document.getElementById('upload-status');
  const uploadButton = document.getElementById('upload-button');

  if (!fileInput || !form) {
    console.error('Form or file input not found');
    return;
  }

  console.log('File input found, has direct_upload attribute:', fileInput.hasAttribute('data-direct-upload-url'));
  console.log('File input attributes:', {
    directUpload: fileInput.getAttribute('data-direct-upload'),
    directUploadUrl: fileInput.getAttribute('data-direct-upload-url'),
    allDataAttributes: Array.from(fileInput.attributes).filter(attr => attr.name.startsWith('data-')).map(attr => `${attr.name}="${attr.value}"`)
  });

  // Ensure data-direct-upload is set if it's missing
  if (!fileInput.hasAttribute('data-direct-upload') && fileInput.hasAttribute('data-direct-upload-url')) {
    fileInput.setAttribute('data-direct-upload', 'true');
    console.log('Manually set data-direct-upload attribute');

    // Try to trigger Active Storage to re-scan
    if (window.ActiveStorage && window.ActiveStorage.start) {
      window.ActiveStorage.start();
      console.log('Re-started Active Storage');
    }
  }

  let directUploadComplete = false;
  let isUploading = false;

  // Use event delegation on the form to catch events even if Active Storage attaches them later
  // Also attach directly to fileInput as a fallback
  function handleDirectUploadInitialize(event) {
    const { detail } = event;
    const { file } = detail;

    console.log('Direct upload initialized for:', file.name);
    isUploading = true;
    directUploadComplete = false;
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = `Uploading ${file.name}...`;
    uploadButton.disabled = true;
    uploadStatus.classList.add('hidden');
  }

  function handleDirectUploadProgress(event) {
    const { detail } = event;
    const { progress } = detail;

    progressBar.style.width = `${progress}%`;
    progressText.textContent = `Uploading... ${Math.round(progress)}%`;
  }

  function handleDirectUploadError(event) {
    event.preventDefault();
    const { detail } = event;
    const { error } = detail;

    console.error('Direct upload error:', error);
    isUploading = false;
    directUploadComplete = false;
    progressContainer.classList.add('hidden');
    uploadButton.disabled = false;

    uploadStatus.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
    uploadStatus.textContent = `Upload failed: ${error}`;
    uploadStatus.classList.remove('hidden');
  }

  function handleDirectUploadEnd(event) {
    const { detail } = event;

    console.log('Direct upload ended');
    progressBar.style.width = '100%';
    progressText.textContent = 'Upload complete! Ready to submit...';
    directUploadComplete = true;
    isUploading = false;
    uploadButton.disabled = false;
  }

  // Attach listeners to both form (event delegation) and fileInput (direct)
  form.addEventListener('direct-upload:initialize', handleDirectUploadInitialize);
  form.addEventListener('direct-upload:progress', handleDirectUploadProgress);
  form.addEventListener('direct-upload:error', handleDirectUploadError);
  form.addEventListener('direct-upload:end', handleDirectUploadEnd);

  fileInput.addEventListener('direct-upload:initialize', handleDirectUploadInitialize);
  fileInput.addEventListener('direct-upload:progress', handleDirectUploadProgress);
  fileInput.addEventListener('direct-upload:error', handleDirectUploadError);
  fileInput.addEventListener('direct-upload:end', handleDirectUploadEnd);

  // Listen for file selection and manually trigger direct upload
  fileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    console.log('File selected:', file?.name);
    if (file) {
      console.log('File input value:', event.target.value);
      const directUploadUrl = fileInput.getAttribute('data-direct-upload-url');
      console.log('Direct upload URL:', directUploadUrl);

      // If Active Storage hasn't started the upload automatically, do it manually
      setTimeout(() => {
        console.log('After file selection, isUploading:', isUploading);
        if (!isUploading && directUploadUrl) {
          console.log('Manually starting direct upload...');
          startDirectUpload(file, directUploadUrl);
        }
      }, 300);
    }
  });

  // Manually implement direct upload using Active Storage DirectUpload class
  function startDirectUpload(file, url) {
    if (isUploading) {
      console.log('Upload already in progress');
      return;
    }

    // Check if ActiveStorage.DirectUpload is available
    if (typeof ActiveStorage === 'undefined' || !ActiveStorage.DirectUpload) {
      console.error('ActiveStorage.DirectUpload not available, trying manual upload');
      manualDirectUpload(file, url);
      return;
    }

    isUploading = true;
    directUploadComplete = false;
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = `Uploading ${file.name}...`;
    uploadButton.disabled = true;
    uploadStatus.classList.add('hidden');

    const upload = new ActiveStorage.DirectUpload(file, url, {
      directUploadWillStoreFileWithXHR: function(xhr) {
        xhr.upload.addEventListener('progress', function(event) {
          if (event.lengthComputable) {
            const progress = (event.loaded / event.total) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Uploading... ${Math.round(progress)}%`;
          }
        });
      }
    });

    upload.create((error, blob) => {
      if (error) {
        console.error('Direct upload error:', error);
        isUploading = false;
        directUploadComplete = false;
        progressContainer.classList.add('hidden');
        uploadButton.disabled = false;

        uploadStatus.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
        uploadStatus.textContent = `Upload failed: ${error}`;
        uploadStatus.classList.remove('hidden');
      } else {
        console.log('Direct upload complete, blob:', blob);

        // Remove any existing hidden input for file
        const existingHidden = form.querySelector('input[type="hidden"][name="upload[file]"]');
        if (existingHidden) {
          existingHidden.remove();
        }

        // Create a hidden input with the signed ID
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'upload[file]';
        hiddenInput.value = blob.signed_id;
        form.appendChild(hiddenInput);

        // Disable the original file input to prevent it from being submitted
        fileInput.disabled = true;

        // Update progress
        progressBar.style.width = '100%';
        progressText.textContent = 'Upload complete! Ready to submit...';
        directUploadComplete = true;
        isUploading = false;
        uploadButton.disabled = false;
      }
    });
  }

  // Fallback manual direct upload implementation
  function manualDirectUpload(file, url) {
    isUploading = true;
    directUploadComplete = false;
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = `Uploading ${file.name}...`;
    uploadButton.disabled = true;
    uploadStatus.classList.add('hidden');

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ||
                     form.querySelector('input[name="authenticity_token"]')?.value;

    // Step 1: Get direct upload metadata
    const formData = new FormData();
    formData.append('blob[filename]', file.name);
    formData.append('blob[content_type]', file.type);
    formData.append('blob[byte_size]', file.size);

    // Let Rails calculate the checksum server-side
    formData.append('blob[checksum]', '');

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        console.log('Direct upload metadata:', data);

        // Step 2: Upload file to signed URL
        const uploadUrl = data.direct_upload.url;
        const headers = data.direct_upload.headers || {};

        const xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const progress = (e.loaded / e.total) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Uploading... ${Math.round(progress)}%`;
          }
        });

        xhr.addEventListener('load', function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            // Remove any existing hidden input for file
            const existingHidden = form.querySelector('input[type="hidden"][name="upload[file]"]');
            if (existingHidden) {
              existingHidden.remove();
            }

            // Create hidden input with signed ID
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'upload[file]';
            hiddenInput.value = data.signed_id;
            form.appendChild(hiddenInput);

            // Disable the original file input to prevent it from being submitted
            fileInput.disabled = true;

            progressBar.style.width = '100%';
            progressText.textContent = 'Upload complete! Ready to submit...';
            directUploadComplete = true;
            isUploading = false;
            uploadButton.disabled = false;
          } else {
            throw new Error(`Upload failed: ${xhr.statusText}`);
          }
        });

        xhr.addEventListener('error', function() {
          throw new Error('Upload failed');
        });

        xhr.open('PUT', uploadUrl);
        Object.keys(headers).forEach(key => {
          xhr.setRequestHeader(key, headers[key]);
        });
        xhr.send(file);
      })
      .catch(error => {
        console.error('Direct upload error:', error);
        isUploading = false;
        directUploadComplete = false;
        progressContainer.classList.add('hidden');
        uploadButton.disabled = false;

        uploadStatus.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
        uploadStatus.textContent = `Upload failed: ${error.message}`;
        uploadStatus.classList.remove('hidden');
      });
  }

  // Handle form submission - only prevent if upload is in progress
  form.addEventListener('submit', function(event) {
    // If direct upload is still in progress, prevent submission
    if (isUploading) {
      event.preventDefault();
      uploadStatus.className = 'bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded';
      uploadStatus.textContent = 'Please wait for the file upload to complete...';
      uploadStatus.classList.remove('hidden');
      return false;
    }

    // If file is selected but direct upload hasn't completed, wait
    if (fileInput.files.length > 0 && !directUploadComplete && fileInput.hasAttribute('data-direct-upload-url')) {
      event.preventDefault();
      uploadStatus.className = 'bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded';
      uploadStatus.textContent = 'Please wait for the file upload to complete...';
      uploadStatus.classList.remove('hidden');
      return false;
    }

    // Allow normal form submission - Active Storage will handle the signed blob ID
    // Show submitting state
    if (fileInput.files.length > 0) {
      uploadButton.disabled = true;
      progressText.textContent = 'Submitting...';
    }
  });
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for Active Storage to initialize
    setTimeout(initializeDirectUpload, 100);
  });
} else {
  // DOM already loaded
  setTimeout(initializeDirectUpload, 100);
}
</script>

